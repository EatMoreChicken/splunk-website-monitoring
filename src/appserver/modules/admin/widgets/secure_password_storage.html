<%page args="element" />
<div id="item-foo" class="widget ">
            <label for="foo_id" class="">Foo
                <span class="requiredAsterisk">*</span>
            </label>
        <div>
            <input type="text" name="foo" id="foo_id" value="test">
            <div class="widgeterror"></div>
            <p class="exampleText"><em>A test</em></p>
        </div>
 </div>

<script type="text/javascript">
/**
 * This module will perform several operations related to secure password storage:
 * 
 *    1) Load an existing secure storage entry and populate the UI with it.
 *    2) Persist the secure storage entry upon form save
 *    3) Clear the existing password entry so that any existing clear-text values will be removed. 
 * 
 * To use this module, you should:
 *    1) 
 * 
 	      <elements>
	      
	        <element name="username" type="textfield" label="Username">
	          <view name="edit"/>
	          <view name="create"/>
	          <key name="exampleText">The username to use for authenticating</key>
	        </element>
	        
	        <element name="password" type="password" label="Password">
	          <view name="edit"/>
	          <view name="create"/>
	          <key name="exampleText">The password to use for authenticating</key>
	        </element>

			<element name="secure_password_storage_fix" type="secure_password_storage">
			  <view name="edit"/>
	          <view name="create"/>
			  <key name="prefix">web_ping://</key>
			</element>
	      </elements>

 */

/**
 * Create a new secure password entry.
 */
var createSecurePassword = function(realm, username, password){

    var data = {
        name: username,
        password: password,
        realm: realm
    }

    return $.ajax({
        url: "/en-US/splunkd/__raw/services/storage/passwords?output_mode=json",
        data: data,
        type: "POST"
    });

}

/**
 * Modify an existing entry of a secure password.
 */
var modifySecurePassword = function(name, realm, username, password){

    var data = {
        //name: username,
        password: password,
        //realm: realm
    }

    return $.ajax({
        url: "/en-US/splunkd/__raw/services/storage/passwords/" + encodeURIComponent(name) + "?output_mode=json",
        data: data,
        type: "POST"
    });

}

/**
 * This holds a reference to the loaded existing secure password entry.
 */
var existingSecurePassword = null;

/**
 * Load the existing secure password entry.
 */
var getSecurePassword = function(realm){

    // Get a promise ready
    var promise = jQuery.Deferred();

    $.ajax({
        url: "/en-US/splunkd/__raw/services/storage/passwords?output_mode=json"
    })
    .done(function(entries){
        promise.resolve(entries.entry.find(function(entry){
            return entry.content.realm === realm;
        }));
    })
    .fail(function(){
        promise.reject();
    });

    return promise;
}

/**
 * Create or update the existing secure password entry. This function tries to make a new one first and will an
 * existing entry if it sees a conflict.
 * 
 * This function will delete any existing entry if the password is being emptied.
 */
var updateSecureStorage = function(realm, username, password){

    // Get a promise ready
    var promise = jQuery.Deferred();

    // TODO delete the entry if the password has been cleared.

    // Try to create an entry
    createSecurePassword(realm, username, password)
    .done(function(){
        console.info("Secure credential created");
        promise.resolve();
    })
    .fail(function(response){

        // If the entry already existed, then update it
        if(response.status === 409){
            debugger;
            modifySecurePassword(existingSecurePassword.name, realm, username, password).done(function(){
                console.info("Secure credential updated");
                promise.resolve();
                debugger;
            })
        }
    });
};

/**
 * Parse the path to obtain the name of the input.
 */
var parseNameInputPath = function(path){
    var parts = decodeURIComponent(path).split("/");
    return parts[parts.length-1];
}

/**
 * Get the requested parameter from the URL.
 */
var getUrlParameter = function(sParam) {

    var sPageURL = decodeURIComponent(window.location.search.substring(1)),
        sURLVariables = sPageURL.split('&'),
        sParameterName,
        i;

    for (i = 0; i < sURLVariables.length; i++) {
        sParameterName = sURLVariables[i].split('=');

        if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : sParameterName[1];
        }
    }
};

/**
 * create the realm name from the name (if the form is making a new entry) or parse it from the URL if it is an existing entry.
 */
var getRealm = function(prefix){

    // Get the name from the name ID field if it exists
    if($('#name_id').length > 0){
        return prefix + $('#name_id').val();
    }
    
    else if(this.getUrlParameter('uri')){
        return prefix + parseNameInputPath(this.getUrlParameter('uri'));
    }

};

$(document).ready(function(){
    //var overrideSelector = "form#eaiform.entityEditForm";
    var overrideSelector = "form#eaiform.entityEditForm .splButton-primary";
    
    // Get the realm name
    var realm = getRealm("${element['prefix']}");

    // Try to load the existing entry
    getSecurePassword(realm).done(function(entry){
        console.info("Loaded the existing entry of the secure password");
        debugger;
        existingSecurePassword = entry;
        // TODO load into the form
    });

    // Get a reference to the original click function
	var originalClickFunction = $(overrideSelector).click;

    // Patch the click function to update the password entry
    $(overrideSelector).click(function(e){
        updateSecureStorage(realm, $('#username_id').val(), $('#password_id').val());
        //originalClickFunction(e);
    });
});
</script>